To resolve the CoreDNS addon degraded status in your EKS cluster deployed via the Terraform AWS module, follow these steps:

1. Verify Subnet Tags

Ensure all subnets (public and private) are correctly tagged for EKS:

```hcl
   tags = {
     "kubernetes.io/role/elb"              = 1        # Public subnets
     "kubernetes.io/role/internal-elb"     = 1        # Private subnets
     "kubernetes.io/cluster/<CLUSTER_NAME>" = "shared" # Replace <CLUSTER_NAME>
   }
```

Incorrect tags prevent CoreDNS pods from accessing AWS services.

2. Check CoreDNS Deployment

Verify CoreDNS pod status and logs:

```bash
   kubectl get pods -n kube-system -l k8s-app=kube-dns
   kubectl logs -n kube-system <coredns-pod-name>
```

Look for errors like network timeouts or permission issues.

3. Validate IAM Permissions

Ensure the EKS cluster role has required permissions for CoreDNS:

· eks:DescribeCluster
· ec2:DescribeInstances
· Attach the AmazonEKS_CNI_Policy to the node IAM roles if missing.

4. Update CoreDNS Configuration

If using custom configuration_values, ensure they are valid JSON. Example:

```hcl
   resource "aws_eks_addon" "coredns" {
     cluster_name      = aws_eks_cluster.main.name
     addon_name        = "coredns"
     addon_version     = "v1.10.1-eksbuild.4" # Match your EKS version
     resolve_conflicts = "OVERWRITE"
   }
```

5. Restart CoreDNS Pods

Delete CoreDNS pods to force restart:

```bash
   kubectl delete pods -n kube-system -l k8s-app=kube-dns
```

6. Check Security Groups

Ensure node security groups allow DNS traffic (TCP/UDP port 53) within the VPC.

7. Verify Kubernetes Network

Confirm the CNI (e.g., AWS VPC CNI) is healthy:

```bash
   kubectl get pods -n kube-system -l app=aws-node
```

8. Use Terraform to Recreate Addon

Taint the CoreDNS addon resource to force recreation:

```bash
   terraform taint aws_eks_addon.coredns
   terraform apply
```

9. Inspect EKS Addon Status

Check addon status via AWS CLI:

```bash
   aws eks describe-addon --cluster-name <CLUSTER_NAME> --addon-name coredns
```

Common Fixes Summary:

· Subnet Tags: Missing kubernetes.io/role/internal-elb on private subnets.
· IAM Roles: Attach AmazonEKS_CNI_Policy to node roles.
· Resource Conflicts: Use resolve_conflicts = "OVERWRITE" in aws_eks_addon.
· Version Mismatch: Ensure CoreDNS addon version is compatible with your EKS version.

After applying these changes, monitor the CoreDNS pods until they transition to the Running state.