To resolve the CoreDNS addon degraded status in your EKS cluster deployed via the Terraform AWS module, follow these steps:

1. Verify Subnet Tags

Ensure all subnets (public and private) are correctly tagged for EKS:

```hcl
   tags = {
     "kubernetes.io/role/elb"              = 1        # Public subnets
     "kubernetes.io/role/internal-elb"     = 1        # Private subnets
     "kubernetes.io/cluster/<CLUSTER_NAME>" = "shared" # Replace <CLUSTER_NAME>
   }
```

Incorrect tags prevent CoreDNS pods from accessing AWS services.

2. Check CoreDNS Deployment

Verify CoreDNS pod status and logs:

```bash
   kubectl get pods -n kube-system -l k8s-app=kube-dns
   kubectl logs -n kube-system <coredns-pod-name>
```

Look for errors like network timeouts or permission issues.

3. Validate IAM Permissions

Ensure the EKS cluster role has required permissions for CoreDNS:

· eks:DescribeCluster
· ec2:DescribeInstances
· Attach the AmazonEKS_CNI_Policy to the node IAM roles if missing.

4. Update CoreDNS Configuration

If using custom configuration_values, ensure they are valid JSON. Example:

```hcl
   resource "aws_eks_addon" "coredns" {
     cluster_name      = aws_eks_cluster.main.name
     addon_name        = "coredns"
     addon_version     = "v1.10.1-eksbuild.4" # Match your EKS version
     resolve_conflicts = "OVERWRITE"
   }
```

5. Restart CoreDNS Pods

Delete CoreDNS pods to force restart:

```bash
   kubectl delete pods -n kube-system -l k8s-app=kube-dns
```

6. Check Security Groups

Ensure node security groups allow DNS traffic (TCP/UDP port 53) within the VPC.

7. Verify Kubernetes Network

Confirm the CNI (e.g., AWS VPC CNI) is healthy:

```bash
   kubectl get pods -n kube-system -l app=aws-node
```

8. Use Terraform to Recreate Addon

Taint the CoreDNS addon resource to force recreation:

```bash
   terraform taint aws_eks_addon.coredns
   terraform apply
```

9. Inspect EKS Addon Status

Check addon status via AWS CLI:

```bash
   aws eks describe-addon --cluster-name <CLUSTER_NAME> --addon-name coredns
```

Common Fixes Summary:

· Subnet Tags: Missing kubernetes.io/role/internal-elb on private subnets.
· IAM Roles: Attach AmazonEKS_CNI_Policy to node roles.
· Resource Conflicts: Use resolve_conflicts = "OVERWRITE" in aws_eks_addon.
· Version Mismatch: Ensure CoreDNS addon version is compatible with your EKS version.

After applying these changes, monitor the CoreDNS pods until they transition to the Running state.

----------------‐---------‐--------------------

eks coredns addons in degraded status when deployin from eks terraform public module

When deploying EKS clusters using the Terraform public module, **CoreDNS addons often show a "degraded" status** due to resource and dependency issues during initial provisioning[1][2][3].

## Causes of Degraded Status

- **Race Condition**: The "degraded" status frequently occurs if the CoreDNS addon is created before the worker node group (which CoreDNS requires to run)[1]. This timing mismatch means the pods cannot be scheduled, causing Terraform to fail or timeout until the underlying resources stabilize[2][3].
- **Node Group Tolerations**: If all nodes are tainted, CoreDNS cannot schedule pods unless tolerations are configured. Even after patching deployments, the EKS console may keep reporting "degraded" status during rolling redeployments[2][4].
- **Permissions and Networking**: Insufficient node IAM permissions or lack of outbound network access also commonly result in addon failures, including the degraded status for CoreDNS[5].

## Recommended Solutions

- **Enforce Creation Order**: Ensure that the node groups are created before the CoreDNS addon by splitting Terraform resources or applying explicit dependencies in the configuration[1][6].
- **Set Tolerations and Configuration**: Use the `configuration_values` block in the addon declaration to specify tolerations, autoscaling settings, and Corefile overrides directly in the module[7][4].
- **Manual Patching**: As a workaround, patch the CoreDNS deployment manually after initial provisioning to apply the necessary tolerations and allow scheduling, but this can be tedious[2][4].
- **Check Permissions and Network**: Validate node roles and network connectivity, as these are common root causes for "degraded" CoreDNS status[5].

## Example Terraform Configuration

```hcl
addons = {
  coredns = {
    addon_version = "v1.11.4-eksbuild.2"
    most_recent = true
    configuration_values = <<EOT
    {
      "corefile": "...your config...",
      "autoScaling": {
        "enabled": true,
        "minReplicas": 2,
        "maxReplicas": 6
      },
      "tolerations": [
        {
          "key": "CriticalAddonsOnly",
          "effect": "NoSchedule",
          "operator": "Exists"
        }
      ]
    }
    EOT
  }
}
```


## Key Actions

- Confirm node groups exist before applying addons[1][3].
- Configure tolerations and autoscaling for CoreDNS[7][4].
- Check permissions and network access for nodes[5].

Following these steps helps stabilize EKS deployments and resolves frequent "degraded" statuses for the CoreDNS addon using the Terraform AWS module[7][1][5].




EKS CoreDNS degraded race condition

The **EKS CoreDNS degraded race condition** occurs when the CoreDNS add-on is deployed before the node group is available, leaving the addon in a "degraded" or "pending" state until nodes are created[1][2].

## Why the Race Condition Happens

- **Deployment Ordering**: With Terraform or other IaC tools, resources can be created in parallel unless dependencies are explicit; CoreDNS add-on requires running nodes to schedule pods, but sometimes gets provisioned before nodes exist[1][2].
- **Effect**: The CoreDNS pods remain unschedulable, the addon is marked as degraded, and eventually Terraform may timeout waiting for the status to become "ACTIVE"[1][2][3].
- **Subsequent Apply**: Running Terraform again often succeeds, as the node group is now present and enables CoreDNS recovery[2].

## Solutions and Best Practices

- **Explicit Dependencies**: Add explicit `depends_on` in your Terraform for the CoreDNS add-on resource, targeting your node group to enforce ordering[2][1].
- **Reapply on Failure**: If timed out, a second `terraform apply` will usually repair the problem.
- **Manual Patch as Last Resort**: Some teams patch the CoreDNS deployment directly after node availability if the addon cannot self-heal[3].

## Example Dependency Block

```hcl
resource "aws_eks_node_group" "default" {
  # node group configuration
}

resource "aws_eks_addon" "coredns" {
  depends_on = [aws_eks_node_group.default]
  # coredns configuration
}
```


## Additional Considerations

- This race condition does not affect all addon types; DaemonSet-based addons (like kube-proxy) do not wait for nodes in the same way[1].
- Always review Terraform and AWS module docs for the latest recommendations specific to EKS node and add-on lifecycle[2].

Managing the provisioning order with strict dependencies is the most effective way to avoid CoreDNS "degraded" status due to race conditions on EKS[2][1][3].

Citations:
[1] Race-Condition with certain EKS Addons · Issue #1838 https://github.com/terraform-aws-modules/terraform-aws-eks/issues/1838
[2] Add-ons management Race condition with Node Groups https://github.com/terraform-aws-modules/terraform-aws-eks/issues/1801
[3] [EKS] coredns still requires a patch to remove the ec2 ... https://www.reddit.com/r/Terraform/comments/vrm8ol/eks_coredns_still_requires_a_patch_to_remove_the/
[4] EKS CoreDNS in a specific managed nodegroup : r/aws - Reddit https://www.reddit.com/r/aws/comments/v8styy/eks_coredns_in_a_specific_managed_nodegroup/
[5] Recent changes to the CoreDNS add-on | Containers https://aws.amazon.com/blogs/containers/recent-changes-to-the-coredns-add-on/
[6] Core DNS degraded in node group add-ons https://stackoverflow.com/questions/71022285/core-dns-degraded-in-node-group-add-ons
[7] Manage CoreDNS for DNS in Amazon EKS clusters https://docs.aws.amazon.com/eks/latest/userguide/managing-coredns.html
[8] Failed to schedule core-dns on fargate: timed out while waiting for ... https://stackoverflow.com/questions/76944287/failed-to-schedule-core-dns-on-fargate-timed-out-while-waiting-for-coredns-to
[9] We spent weeks debugging a Kubernetes issue that ended ... https://www.reddit.com/r/kubernetes/comments/1mi8yyr/we_spent_weeks_debugging_a_kubernetes_issue_that/
[10] Scale from 100 to 10,000 pods on Amazon EKS | Containers https://aws.amazon.com/blogs/containers/scale-from-100-to-10000-pods-on-amazon-eks/
[11] Troubleshooting CoreDNS Performance on AWS EKS for ... https://dasmeta.com/cloud-infrastructure-blog/troubleshooting-coredns-performance-issues-an-essential-guide-for-startups-on-aws-eks
[12] Monitoring CoreDNS for DNS throttling issues using ... https://aws.amazon.com/blogs/mt/monitoring-coredns-for-dns-throttling-issues-using-aws-open-source-monitoring-services/
[13] Kubenet network performance degraded, solved using ... https://discuss.kubernetes.io/t/kubenet-network-performance-degraded-solved-using-hostnetwork-true-with-unicorn-app/2874
Citations:
[1] Add-ons management Race condition with Node Groups https://github.com/terraform-aws-modules/terraform-aws-eks/issues/1801
[2] [EKS Add-On] [CoreDNS]: Patched Add-On never recovers ... - GitHub https://github.com/aws/containers-roadmap/issues/1389
[3] EKS managed group example times out during CoreDNS ... https://github.com/terraform-aws-modules/terraform-aws-eks/issues/2585
[4] How can I apply tolerations to EKS's Add-Ons when using ... https://stackoverflow.com/questions/79400204/how-can-i-apply-tolerations-to-ekss-add-ons-when-using-terraform
[5] Troubleshoot problems with Amazon EKS clusters and nodes https://docs.aws.amazon.com/eks/latest/userguide/troubleshooting.html
[6] Errors with coredns and configmap during deploying aws ... https://discuss.hashicorp.com/t/errors-with-coredns-and-configmap-during-deploying-aws-eks-module-via-terraform/38610
[7] Set custom configuration in AWS EKS CoreDNS Addon https://dev.to/aws-builders/set-custom-configuration-in-aws-eks-coredns-addon-fh2
[8] Core DNS degraded in node group add-ons https://stackoverflow.com/questions/71022285/core-dns-degraded-in-node-group-add-ons
[9] What is a EKS Addon in AWS? - Overmind https://overmind.tech/types/eks-addon
[10] squareops/eks-addons/aws | aws-coredns Submodule https://registry.terraform.io/modules/squareops/eks-addons/aws/1.1.5/submodules/aws-coredns
[11] EKS AWS module - Terraform Registry https://registry.terraform.io/modules/terraform-aws-modules/eks/aws/latest
[12] Terraform : EKS Addon Setup https://faun.pub/terraform-eks-addon-setup-d9312629d26
[13] Manage CoreDNS for DNS in Amazon EKS clusters https://docs.aws.amazon.com/eks/latest/userguide/managing-coredns.html