Terraform Code to Fetch ACM Certificate ARN with Graceful Handling

As a DevOps engineer, here's a Terraform implementation that fetches an ACM certificate ARN by domain name and gracefully handles cases where the certificate doesn't exist:

```hcl
# Configure the AWS Provider
provider "aws" {
  region = "us-east-1" # ACM certificates are typically in us-east-1 for CloudFront
}

variable "domain_name" {
  description = "The domain name to search for in ACM certificates"
  type        = string
  default     = "example.com"
}

# Data source to get all ACM certificates
data "aws_acm_certificate" "selected" {
  domain   = var.domain_name
  statuses = ["ISSUED"]
  most_recent = true
}

# Locals to handle the case where certificate doesn't exist
locals {
  # Try to get the certificate ARN, fallback to null if it doesn't exist
  acm_certificate_arn = try(data.aws_acm_certificate.selected.arn, null)
  
  # Boolean to check if certificate exists
  certificate_exists = local.acm_certificate_arn != null
  
  # Optional: Create a more descriptive message
  certificate_status = local.certificate_exists ? 
    "Certificate found: ${local.acm_certificate_arn}" : 
    "No ACM certificate found for domain: ${var.domain_name}"
}

# Output the results
output "acm_certificate_arn" {
  description = "The ARN of the ACM certificate for the specified domain"
  value       = local.acm_certificate_arn
}

output "certificate_exists" {
  description = "Whether an ACM certificate was found for the specified domain"
  value       = local.certificate_exists
}

output "certificate_status_message" {
  description = "Status message about the certificate lookup"
  value       = local.certificate_status
}

# Example usage of the certificate ARN (conditional)
resource "aws_cloudfront_distribution" "example" {
  count = local.certificate_exists ? 1 : 0
  
  # Other CloudFront configuration...
  
  viewer_certificate {
    acm_certificate_arn = local.acm_certificate_arn
    ssl_support_method  = "sni-only"
  }
}
```

Alternative Approach Using External Data Source

For more advanced handling, you can use an external script to check for certificate existence:

```hcl
variable "domain_name" {
  description = "The domain name to search for in ACM certificates"
  type        = string
}

data "external" "acm_certificate_check" {
  program = ["bash", "${path.module}/check_acm_certificate.sh"]
  
  query = {
    domain_name = var.domain_name
    region      = "us-east-1"
  }
}

locals {
  acm_certificate_arn = data.external.acm_certificate_check.result.arn != "" ? 
    data.external.acm_certificate_check.result.arn : 
    null
}

output "acm_certificate_arn" {
  value = local.acm_certificate_arn
}
```

Create a check_acm_certificate.sh script:

```bash
#!/bin/bash

# Read input from Terraform
eval "$(jq -r '@sh "domain_name=\(.domain_name) region=\(.region)"')"

# Check for ACM certificate
cert_arn=$(aws acm list-certificates --region $region --query "CertificateSummaryList[?DomainName=='$domain_name'].CertificateArn" --output text)

# Return result to Terraform
if [ -z "$cert_arn" ]; then
  jq -n --arg arn "" '{ "arn": $arn }'
else
  jq -n --arg arn "$cert_arn" '{ "arn": $arn }'
fi
```

Key Features of This Implementation:

1. Error Handling: Uses Terraform's try() function to gracefully handle missing certificates
2. Flexible Status Checking: Provides both the ARN and a boolean indicating existence
3. Conditional Resource Creation: Demonstrates how to conditionally create resources based on certificate existence
4. Multiple Approaches: Shows both pure-Terraform and script-based solutions
5. Clear Outputs: Provides informative output values for use in other modules

Usage Notes:

1. Make sure your AWS credentials are properly configured with permissions to access ACM
2. The script-based approach requires jq and AWS CLI to be installed
3. Adjust the region according to where your ACM certificates are located (us-east-1 is common for CloudFront)
4. You can modify the statuses parameter to look for certificates in different states

This implementation ensures your Terraform code won't fail when certificates don't exist, allowing for more robust infrastructure management.